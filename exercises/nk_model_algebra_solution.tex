\begin{enumerate}

\item
The optimization problem is framed by the following Lagrangian:
\begin{align*}
\mathcal{L} &= \mathbb{E}_{t} \sum_{j=0}^{\infty} \beta^{j} \mu_{t+j} \Bigg \{
  \frac{1}{1-\sigma^{C}} {(C_{t+j}[h])}^{1-\sigma^{C}}
  - \chi^{L} \frac{1}{1+\sigma^{L}} {(L^{s}_{t+j}[h])}^{1+\sigma^{L}}
  \Bigg \}
\\
&+ \mathbb{E}_{t} \sum_{j=0}^{\infty} \beta^{j} \frac{\Lambda_{t+j}[h]}{P_{t+j}} \Bigg \{
  R^{K}_{t+j} K_{t+j-1}[h]
+ W_{t+j} L^{s}_{t+j}[h]
- P_{t+j} C_{t+j}[h] - P_{t+j} I_{t+j}[h]
- \mathcal{T}_{t+j}[h]
\\
&\qquad\qquad\qquad\qquad\qquad
- \sum_{s' \in \mathcal{S}} P^{\mathcal{B}}_{t+j}[s'] \mathcal{B}_{t+j}[s',h]
+ \mathcal{B}_{t+j-1}[s,h]
\\
&\qquad\qquad\qquad\qquad\qquad\qquad\qquad
+ \frac{1}{n} \int_{0}^{n} \mathcal{DIV}^{F}_{t+j}[f] df
+ \frac{1}{n} \int_{0}^{n} \mathcal{DIV}^{M}_{t+j}[m] dm
\Bigg \}
\\
&+ \mathbb{E}_{t} \sum_{j=0}^{\infty} \beta^{j} \frac{\Lambda_{t+j}[h] Q^{K}_{t+j}[h]}{P_{t+j}} \Bigg \{
(1-\delta^{K}) K_{t+j-1}[h]  - K_{t+j}[h] + I_{t+j}[h] 
\\
&\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad
- \frac{\phi^{I}}{2} {\left(\frac{I_{t+j}[h]}{I_{t+j-1}[h]} - 1 \right)}^2 I_{t+j}[h]
\Bigg \}
\end{align*}

\item
\textbf{State-contingent bonds:} Setting the derivative of \(\mathcal{L}\) with respect to \(\mathcal{B}_{t}[s,h]\) to zero yields:
\begin{align*}
\mathbb{E}_{t} \frac{\Lambda_{t}[h]}{\Lambda_{t+1}[h]} = \beta \frac{1}{P^{\mathcal{B}}_{t}[s]} \mathbb{E}_{t} \underbrace{\frac{P_{t}}{P_{t+1}}}_{{(\Pi_{t+1})}^{-1}}
\end{align*}
where \(s\) is the realized state in period \(t\).
Integrating over all \(h\) yields the Euler equation for bonds in per-capita terms:
\begin{align*}
P^{\mathcal{B}}_{t}[s] \underbrace{\frac{1}{n} \int_{0}^{n} \Lambda_{t}[h] dh}_{\lambda_{t}}  &= \beta \mathbb{E}_{t} \frac{1}{\Pi_{t+1}} \underbrace{\frac{1}{n}\int_{0}^{n} \Lambda_{t+1}[h] dh}_{\lambda_{t+1}}
\\
\Leftrightarrow
\mathbb{E}_{t} \frac{\lambda_{t}}{\lambda_{t+1}} &= \beta \frac{1}{P^{\mathcal{B}}_{t}[s]} \mathbb{E}_{t} \frac{1}{\Pi_{t+1}}
\\
\Leftrightarrow
P^{\mathcal{B}}_{t}[s] &= \beta \mathbb{E}_{t} \frac{\lambda_{t+1}}{\lambda_{t}} \frac{1}{\Pi_{t+1}} =: \mathcal{M}_{t|t+1}
\end{align*}
Equating the first with the last expression yields:
\begin{gather*}
\mathbb{E}_{t} \frac{\Lambda_{t}[h]}{\Lambda_{t+1}[h]} = \mathbb{E}_{t} \frac{\lambda_{t}}{\lambda_{t+1}}
\Leftrightarrow
\Lambda_{t}[h] = \lambda_{t}
\end{gather*}
That is, the Lagrange multiplier is identical for all households.

\emph{Interpretation:}
This is the so-called Bond Euler equation,
 referring to the optimal \emph{intertemporal} choice between consumption and saving into bonds.
We have an indifference condition; that is,
  an additional unit of consumption yields either marginal utility today in the amount of \(\lambda_t\) (left-hand side);
or, alternatively, this unit of consumption can be saved given the \emph{real interest rate} \(r_{t} := R_{t}/\mathbb{E}_{t}\Pi_{t+1}\).\footnote{%
  The relationship between nominal interest rates and expected inflation, i.e.\
    that inflation expectations are responsible for the difference between nominal and real interest rates,
    is known as the \emph{Fisher} equation.}
This saved consumption unit has a present marginal utility value of \(\beta \mathbb{E}_{t} \lambda_{t+1} r_{t}\) (right-hand side).
An optimal allocation equates these two choices.
\begin{align*}
P^{\mathcal{B}}_{t}[s] = \frac{1}{R_{t}} = \mathcal{M}_{t|t+1}
\end{align*}
This captures that bond prices are inversely related to interest rates.
When the interest rate goes up, the price of bonds falls.
Intuitively, this makes sense because if you are paying less for a fixed nominal return (at par),
  your expected return should be higher.

\item
The households optimality conditions are derived by setting the derivative of the Lagrangian
  with respect to the endogenous variables to zero.

\paragraph{First-order condition with respect to \(C_{t}[h]\)}
\begin{align*}
\Lambda_{t}[h] = \mu_{t} U_{C,t} = \mu_{t} {(C_t[h])}^{-\sigma^{C}}
\end{align*}
Because \(\lambda_{t} = \Lambda_{t}[h]\) we can re-write this in per-capita terms by integrating over \(h\):
\begin{gather*}
\frac{1}{n} \int_{0}^{n} {(\lambda_{t})}^{\sigma^{C}} dh = {(\mu_{t})}^{\sigma^{C}} \underbrace{\frac{1}{n} \int_{0}^{1} C_t[h] dh}_{c_{t}}
\\
\Leftrightarrow
\lambda_{t} = \mu_{t} {(c_t)}^{-\sigma^{C}}
\end{gather*}
\emph{Interpretation:} The equation is the marginal consumption utility function, i.e.\
  the benefit (shadow price) of an additional unit of revenue (e.g.\ dividends, capital or labor income) in the budget constraint.
Note that because the Lagrange multiplier is the same for all households,
  the households also choose the same level of consumption in an optimum: \(C_{t}[h] = c_{t}\) for all \(h\).

\paragraph{First-order condition with respect to \(L^{s}_{t}[h]\)}
\begin{align*}
\underbrace{\frac{W_{t}}{P_{t}}}_{w_{t}} = - \frac{\mu_{t} U_{L,t}}{\mu_{t} U_{C,t}} = \chi^{L} {(L^{s}_{t}[h])}^{\sigma^{L}} {(C_{t}[h])}^{\sigma^{C}}
\end{align*}
Integrating over \(h\) and making use of the fact that \(C_{t}[h] = c_{t}\) yields:
\begin{align*}
w_{t} = \chi^{L} {(l^{s}_{t})}^{\sigma^{L}} {(c_{t})}^{\sigma^{C}}
\end{align*}
\emph{Interpretation:} This is the \textbf{intratemporal} optimality condition or, in other words, the labor supply curve of the household.
Note that the preference shifter \(\mu_t\) has no effect on this intratemporal decision.

\paragraph{First-order condition with respect to \(K_{t}[h]\)}
\begin{align*}
\frac{Q^{K}_{t}[h]}{P_{t}} &= \beta \mathbb{E}_{t} \frac{\Lambda_{t+1}[h]}{\Lambda_{t}[h]} \left( \frac{R^{K}_{t+1}}{P_{t+1}} + \frac{Q^{K}_{t+1}[h]}{P_{t+1}} (1-\delta^{K}) \right)
\end{align*}
Integrating over \(h\) yields the Euler equation for capital in per-capita terms:
\begin{align*}
q^{K}_{t} &= \beta \mathbb{E}_{t} \frac{\lambda_{t+1}}{\lambda_{t}} \left( r^{K}_{t+1} + q^{K}_{t+1}(1-\delta^{K}) \right)
\end{align*}
\emph{Interpretation:} This is the capital Euler equation.
It is similar to the Bond Euler equation; however, in terms of saving into the capital stock instead of bonds.
Note that due to the same pricing kernel \(\beta \mathbb{E}_{t} \lambda_{t+1}/\lambda_t\)
  there is arbitrage between the real rate on bonds and the compensation of capital.
Moreover, we see that \(Q^{K}_{t}[h]/P_{t} = q^{K}_{t}\) is the same for all \(h\).

\paragraph{First-order condition with respect to \(I_{t}[h]\)}
\begin{multline*}
1 = \frac{Q^{K}_{t}[h]}{P_{t}} \left( 1 - \frac{\phi^{I}}{2} {\left(\frac{I_{t}[h]}{I_{t-1}[h]}-1\right)}^2 - \phi^{I} \left(\frac{I_{t}[h]}{I_{t-1}[h]}-1\right) \left(\frac{I_{t}[h]}{I_{t-1}[h]}\right) \right)
\\
+ \beta \mathbb{E}_{t} \frac{\Lambda_{t+1}[h]}{\Lambda_{t}[h]} \frac{Q^{K}_{t+1}[h]}{P_{t+1}} \phi^{I} \left(\frac{I_{t+1}[h]}{I_{t}[h]}-1\right) {\left(\frac{I_{t+1}[h]}{I_{t}[h]}\right)}^2
\end{multline*}
Because both \(\Lambda_{t}[h]=\lambda_{t}\) as well as \(Q^{K}_{t}[h]/P_{t} = q^{K}_{t}\),
  the investment ratios, \(I_{t}[h]/I_{t-1}[h]\) align across all households in an optimal choice.
By defining per-capita investment, it follows that \(I_{t}[h]/I_{t-1}[h] = i_{t}/i_{t-1}\).
Hence, the first-order condition can be re-written in terms of per-capita variables:
\begin{align*}
1 = q^{K}_{t} \left( 1 - \frac{\phi^{I}}{2} {\left(\frac{i_{t}}{i_{t-1}}-1\right)}^2 - \phi^{I} \left(\frac{i_{t}}{i_{t-1}}-1\right) \left(\frac{i_{t}}{i_{t-1}}\right) \right)
+ \beta \mathbb{E}_{t} \frac{\lambda_{t+1}}{\lambda_{t}} q^{K}_{t+1} \phi^{I} \left(\frac{i_{t+1}}{i_{t}}-1\right) {\left(\frac{i_{t+1}}{i_{t}}\right)}^2
\end{align*}
\emph{Interpretation:}
This is the Euler equation for investment,
  i.e.\ the optimal choice for choosing investment in the face of adjustment costs.
Note that the Lagrange multiplier associated with the capital stock represents a shadow price of capital;
  this is often referred to as \emph{Tobin's Q},
  which is defined as the ratio of the market value of an asset (like capital) over the replacement cost of that asset.
Accordingly, \(q^{K}_t\) is the marginal Tobin's Q ratio,
  that measures the additional market value of capital that the households can create by investing in new capital.
If \(q^{K}_{t}>1\), then the households value the additional capital more than its costs in consumption terms;
  if \(q^{K}_{t}<1\), then the household will delay investment as the benefit is lower than its cost.
Without investment adjustment costs (\(\phi^{I}=0\)), the ratio would be 1;
  investment in capital happens instantaneously, there is no wedge between costs and benefits.

\item
Due to the presence of state-contingent bonds, the households fully insure their income risk
  and choose identical consumption paths and labor supply levels,
  as well as investment and capital decisions across all states.
Hence, per-capita variables are actually the same as the individual variables, e.g.\
  \(C_{t}[h] = c_{t}\) for all \(h\).
In many papers and textbooks this is often implicitly done by imposing identical allocations (\emph{symmetric equilibrium}),
  or by assuming a representative family makes decisions for all households.
Hence, you very often will find that the \(h\) index is dropped from the notation.
Of course, there are models where heterogeneity is important (e.g.\ inequality) and the \(h\) index is kept.

\item
Re-visiting the law of motion for capital, one can re-write it in per-capita terms
  because the average investment ratio is identical across all households in an optimum:
\begin{align*}
k_{t} &= (1-\delta^{K}) k_{t-1} + \Biggl( 1 - \frac{\phi^{I}}{2} {\left(\frac{i_{t}}{i_{t-1}} - 1 \right)}^2 \Biggr) i_{t}
\end{align*}
If \(\phi^{I}=0\), then the capital stock can be adjusted instantaneously.
If, however, \(\phi^{i}>0\), the model features a real rigidity in form of a quadratic adjustment costs.
That is, there is a loss of capital in the investment process,
  which adds a cost to the marginal productivity of capital.
In New Keynesian models, the presence of such investment adjustment costs can lead to a delay in the response of investment to changes in economic conditions;
  and thus better capture the behavior of firms and the implications of investment decisions for the overall economy.
Note that we put a convex cost on the variation in the growth rate of investment \(I_{t}[h]/I_{t-1}[h]\).

\item
Inserting the marginal utilities, \(U_{C,t} = c_{t}^{-\sigma^{C}}\) and \(U_{CC,t} = - \sigma^{C} c_{t}^{-\sigma^{C}-1}\), yields:
\begin{align*}
{IES} = -\frac{c_{t}^{-\sigma^{C}}}{-\sigma^{C} c_{t}^{-\sigma^{C}-1} c_t} = \frac{1}{\sigma^{C}}
\end{align*}

\item
The Frisch elasticity of labor (FEL) is a measure of how responsive the labor supply is to changes in the real wage rate:
\begin{align*}
FEL = \frac{\frac{\partial{l^{s}_{t}}}{l^{s}_{t}}}{\frac{\partial{w_{t}}}{w_{t}}} = \frac{\partial l^{s}_{t}}{\partial w_{t}} \frac{w_{t}}{l^{s}_{t}}
\end{align*}
We can compute it via differentiating equation~\eqref{eq:NewKeynesian.LaborSupply}:
\begin{align*}
\frac{\partial w_{t}}{\partial l^{s}_{t}} = \chi^{L} \sigma^{L} {(l^{s}_{t})}^{\sigma^{L}-1} {(c_{t})}^{\sigma^{C}}
\end{align*}
Multiplying both sides with \(l^{s}_{t}/w_{t}\) and taking into account equation~\eqref{eq:NewKeynesian.LaborSupply} yields:
\begin{align*}
\frac{1}{FEL} = \sigma^{L} 
\end{align*}
A high Frisch elasticity of labor means that households are highly responsive to changes in their wage rate 
  and wish to adjust their work hours or participation in the labor market accordingly.

\item In equilibrium, bond-holding is always zero in all periods.
This is due to the fact that in this model all households behave symmetrically.
If all agents were borrowing, there would be nobody they could be borrowing from.
If all were lenders, nobody would like to borrow from them.
In sum the price of bonds (or more specifically the nominal interest rate) adjusts such
  that bonds across all agents are in \emph{zero net supply} as markets need to clear in equilibrium.
Note, though, that this bond market clearing condition is imposed
  \emph{after} we derive the households optimality conditions
  as household savings behavior in equilibrium still needs to be consistent with the bond market clearing.

\item
The \emph{No-Ponzi-Game} or \emph{solvency} condition is an external requirement
  ensuring that individuals do not accumulate unbounded debt.
This constraint is crucial in models with an infinite time horizon
  to prevent agents from engaging in a so-called Ponzi scheme---continuously borrowing to cover previous debts
  and finance ongoing consumption.
Although the individual prefers to indefinitely increase their debt due to the infinite time horizon,
  this behavior is curbed by market mechanisms or regulatory bodies,
  and in our case we are enforcing this externally (and mathematically).

\textbf{In short:} \emph{solvency} conditions ensure that households cannot spend beyond their means indefinitely
  by using excessive borrowing to fun consumption that exceed their lifetime income.

The \emph{transversality condition} is an optimality condition that states
  that it is not optimal to start accumulating assets and never consume them.
This condition must be satisfied in order for the individual to maximize intertemporal utility implying
  that at the limit wealth should be zero.
In other words, if at the limit wealth is positive
  it means that the household could have increased its consumption
  without necessarily needing to work more hours;
  thus implying that consumption was not maximized
  and therefore contradicting the fact that the household behaves optimally.

\textbf{In short:} transversality conditions ensure
  that households do no have any leftover savings (in terms of bonds or capital)
  as this does not correspond to an optimal path of utility-enhancing consumption.
	
In our model, both the \emph{solvency} and \emph{transversality} conditions for \emph{private bonds} are full-filled already
  as bond-holding is always zero in all periods including the hypothetical asymptotic end of life: \(\mathcal{B}_t=0\) for all \(t\).

\item
This can be shown by using the definition of the stochastic discount factor.
\begin{align*}
\mathcal{M}_{t,t} &= 1
\\
\mathcal{M}_{t+1,t+1+j} & = \beta^{j} \frac{\lambda_{t+1+j}}{\lambda_{t+1}} \frac{P_{t+1}}{P_{t+1+j}}
\\
\mathcal{M}_{t,t+1+j} & = \beta^{j+1} \frac{\lambda_{t+1+j}}{\lambda_{t}} \frac{P_{t}}{P_{t+1+j}}
= \beta \frac{\lambda_{t+1}}{\lambda_{t}} \frac{P_{t}}{P_{t+1}} \beta^{j} \frac{\lambda_{t+1+j}}{\lambda_{t+1}} \frac{P_{t+1}}{P_{t+1+j}}
= \beta \frac{\lambda_{t+1}}{\lambda_{t}} \Pi_{t+1}^{-1} \mathcal{M}_{t+1,t+1+j}
\end{align*}
We will need this later to derive the recursive nonlinear price setting equations.

\item The cost minimization problem is framed by the following Lagrangian:
\begin{align*}
\mathcal{L} = \int_{0}^{n} P_{t}[m] Y_{t}[f,m] dm
+ P_{t} \Bigg \{
  Y_{t}[f] - {\left( {\left(\frac{1}{n}\right)}^{\frac{1}{\epsilon^{P}}} \int_{0}^{n} {(Y_{t}[f,m])}^{\frac{\epsilon^{P}-1}{\epsilon^{P}}} dm \right)}^{\frac{\epsilon^{P}}{\epsilon^{P}-1}}
\Bigg \}
\end{align*}
where the Lagrange multiplier is the gain of an additional output unit;
hence, equal to the aggregate price index \(P_{t}\) (the price of one unit of the wholesale bundle \(Y_{t}[f]\)).
Setting the first-order condition with respect to \(Y_{t}[f,m]\) to zero yields:
\begin{multline*}
\frac{\partial \mathcal{L} }{\partial Y_{t}[f,m]} =
P_{t}[m] - P_{t} \frac{\epsilon^{P}}{\epsilon^{P}-1}
\\
\underbrace{%
  {\left(
    {\left(\frac{1}{n}\right)}^{\frac{1}{\epsilon^{P}}}
    \int_{0}^{n} {(Y_{t}[f,m])}^{\frac{\epsilon^{P}-1}{\epsilon^{P}}}dm
  \right)}^{\frac{\epsilon^{P}}{\epsilon^{P}-1}-1}
}_{{(Y_{t}[f])}^{1/\epsilon^{P}}}
\frac{\epsilon^{P}-1}{\epsilon^{P}}
{\left(\frac{1}{n}\right)}^{\frac{1}{\epsilon^{P}}}
\underbrace{%
  {(Y_{t}[f,m])}^{\frac{\epsilon^{P}-1}{\epsilon^{P}}-1}
}_{{(Y_{t}[f,m])}^{-1/\epsilon^{P}}}
= 0
\end{multline*}
Reordering yields equation~\eqref{eq:NewKeynesian.Firms.Demand}
\begin{align*}
Y_{t}[f,m] = \frac{1}{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} Y_{t}[f]
\end{align*}
\emph{Interpretation:}
This is the demand curve for intermediate good \(m\) demanded by firm \(f\),
  where the price elasticity is constant and equal to \(\epsilon^{P}\).

The aggregate price index~\eqref{eq:NewKeynesian.Firms.AggregatePriceIndex} is implicitly determined
  by inserting the demand curve~\eqref{eq:NewKeynesian.Firms.Demand}
  into the aggregator~\eqref{eq:NewKeynesian.Firms.Aggregator}:
\begin{align*}
{(Y_{t}[f])}^{\frac{\epsilon^{P}-1}{\epsilon^{P}}} &=
  {\left(\frac{1}{n}\right)}^{\frac{1}{\epsilon^{P}}}
  \int\limits_{0}^{n} {\left(
                       \frac{1}{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} Y_{t}[f]
                       \right)}^{\frac{\epsilon^{P}-1}{\epsilon^{P}}}
                       dm
\\
\Leftrightarrow
P_t &= {\left(\frac{1}{n} \int_{0}^{n} {(P_{t}[m])}^{1-\epsilon^{P}}dm\right)}^{\frac{1}{1-\epsilon^{P}}}
\\
\Leftrightarrow
1 &= \frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{1-\epsilon^{P}}dm
\end{align*}
The aggregate price index is a weighted average of the prices of the intermediate goods.

\item
Total demand for intermediate good \(m\) follows directly when aggregating equation~\eqref{eq:NewKeynesian.Firms.Demand} over \(f\):
\begin{align*}
Y^{d}_{t}[m] := \int_{0}^{n} Y_{t}[f,m] df
= {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} \underbrace{\frac{1}{n} \int_{0}^{n} Y_{t}[f] df}_{y_{t}}
= {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} y_{t}
\end{align*}
Note that \(y_{t}\) is a per-capita variable.

\item
Nominal profits of a firm \(f\) are defined as the difference between total revenues and total costs:
\begin{align*}
\mathcal{DIV}^{F}_{t}[f]
&= P_{t} Y_{t}[f] - \int_{0}^{n} P_{t}[m] {\color{blue}Y_{t}[f,m]} dm
\\
&\overset{\eqref{eq:NewKeynesian.Firms.Demand}}{=}
P_{t} Y_{t}[f] - {\color{red}{P_{t}}}\int_{0}^{n} \frac{P_{t}[m]}{{\color{red}P_{t}}}
{\color{blue} \frac{1}{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} Y_{t}[f]}
dm
\\
&=
P_{t} Y_{t}[f] - P_{t} Y_{t}[f]
\underbrace{%
  \frac{1}{n} \int_{0}^{n}  {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{1-\epsilon^{P}} dm
}_{\overset{\eqref{eq:NewKeynesian.Firms.AggregatePriceIndex}}{=1}}
= 0
\end{align*}
There are no profits in the final good sector of the economy:
\begin{align}
\mathcal{DIV}^{F}_{t}[f] = 0 \label{eq:NewKeynesian.Firms.Final.ZeroProfit}
\end{align}
This is a manifestation of perfect competition;
  hence, the equation~\eqref{eq:NewKeynesian.Firms.ZeroProfit} is called the \emph{zero profit condition}.

\item
As firms are owned by the household, future profits directly increase the revenue side of the households budget constraint~\eqref{eq:NewKeynesian.BudgetNominal}.
Additional revenues are valued by their increase in consumption possibilities \(\lambda_{t}\) in period \(t\), \(\beta \lambda_{t+1}\) in \(t+1\) etc.
Therefore, we use the stochastic discount factor \(\mathcal{M}_{t,t+j}\) to compare the benefit of changes in future profits relative to today.
The profit maximization problem is accordingly framed by the following Lagrangian:
\begin{multline}
\mathcal{L} = \mathbb{E}_{t} \sum_{j=0}^{\infty} \mathcal{M}_{t,t+j} \Bigg \{
P_{t+j}[m] Y^{d}_{t+j}[m] - W_{t+j} L^{d}_{t+j}[m] - R^{K}_{t+j} K^{d}_{t-1+j}[m]
\\
+ {MC}_{t+j}[m] \left(
  A_{t+j} {(K^{d}_{t-1+j}[m])}^{\alpha^{K}} {(L^{d}_{t+j}[m])}^{1-\alpha^{K}} - Y^{d}_{t+j}[m]\right)
\Bigg \}
\label{eq:IntermediateFirms.Lagrangian}
\end{multline}
The Lagrange multiplier \({MC}_{t}[m]\) is the shadow price of producing an additional output unit in the optimum;
  obviously, this is the definition of nominal marginal costs.

\item
Taking the derivative wrt \(L^{d}_{t}[m]\) and \(K^{d}_{t-1}[m]\) actually boils down to a static problem
  (as we only need to evaluate the Lagrangian for \(j=0\))
  and directly yields equations~\eqref{eq:NewKeynesian.IntermediateFirms.CapitalDemand} and~\eqref{eq:NewKeynesian.IntermediateFirms.LaborDemand}:
\begin{align*}
\frac{R^{K}_{t}}{{MC}_{t}[m]} &= \alpha^{K} A_{t} {\left(\frac{L^{d}_{t}[m]}{K^{d}_{t-1}[m]}\right)}^{1-\alpha^{K}}
\\
\frac{W_{t}}{{MC}_{t}[m]} &= (1-\alpha^{K}) A_{t} {\left(\frac{L^{d}_{t}[m]}{K^{d}_{t-1}[m]}\right)}^{-\alpha^{K}}
\end{align*}
\emph{Interpretation:} These are the capital demand and labor demand functions.

\item
Dividing equation~\eqref{eq:NewKeynesian.IntermediateFirms.CapitalDemand} by~\eqref{eq:NewKeynesian.IntermediateFirms.LaborDemand}
  yields equation~\eqref{eq:NewKeynesian.IntermediateFirms.CapitalLaborRatio}:
\begin{align*}
\frac{K^{d}_{t-1}[m]}{L^{d}_{t}[m]} = \frac{\alpha^{K}}{1-\alpha^{K}} \frac{W_{t}}{R^K_{t}}
\end{align*}
\emph{Interpretation:} As the right-hand-side is independent of \(m\), all firms use the same capital to labor ratio in production.
This is because they face the same input prices and have identical production functions and parameters.
Integrating over \(m\) enables us to re-write the equation in per-capita terms:
\begin{gather*}
\underbrace{\frac{1}{n} \int_{0}^{n} K^{d}_{t-1}[m] dm}_{k^{d}_{t-1}}
= \left(\frac{\alpha^{K}}{1-\alpha^{K}}\right) \left(\frac{W_{t}/{\color{red}P_{t}}}{R^{K}_{t}/{\color{red}P_{t}}}\right)
\underbrace{\frac{1}{n} \int_{0}^{n} L^{d}_{t}[m] dm}_{l^{d}_{t}}
\\
\Leftrightarrow
\frac{k^{d}_{t-1}}{l^{d}_{t}} = \left(\frac{\alpha^{K}}{1-\alpha^{K}}\right) \frac{w_{t}}{r^{K}_{t}}
\end{gather*}

\item
Inserting equation~\eqref{eq:NewKeynesian.IntermediateFirms.CapitalLaborRatio} into
  either the capital demand function~\eqref{eq:NewKeynesian.IntermediateFirms.CapitalDemand}
  or the labor demand function~\eqref{eq:NewKeynesian.IntermediateFirms.LaborDemand}
  yields after some rearranging equation~\eqref{eq:NewKeynesian.RealMarginalCosts}:
\begin{align*}
{mc}_{t}[m] = \frac{{MC}_{t}[m]}{P_{t}} =  \frac{1}{A_{t}} {\left(\frac{W_{t}/P_{t}}{1-\alpha^{K}}\right)}^{1-\alpha^{K}} {\left(\frac{R^{K}_{t}/P_{t}}{\alpha^{K}}\right)}^{\alpha^{K}}
\end{align*}
\emph{Interpretation:} As labor and capital inputs are supplied by homogenous factor markets,
  the right-hand side is independent of \(m\).
In other words, all firms face the same marginal costs and we denote this by dropping the \(m\).
More formally, we can integrate the equation over \(m\) and use \({mc}_{t} = \frac{1}{n} \int_{0}^{n} {mc}_{t}[m]dm\).
	

\item
Revisit the Lagrangian of the intermediate firm~\eqref{eq:IntermediateFirms.Lagrangian}
  and focus only on the relevant terms for price optimization:
\begin{align*}
\mathcal{L} &= \mathbb{E}_{t} \sum_{j=0}^{\infty} \mathcal{M}_{t,t+j} \Bigg \{
P_{t+j}[m] Y^{d}_{t+j}[m] - \cdots
+ {MC}_{t+j} \left(
  \cdots - Y^{d}_{t+j}[m]\right)
\Bigg \}
\\
&= \mathbb{E}_{t} \sum_{j=0}^{\infty} \mathcal{M}_{t,t+j} \Bigg \{
\left(P_{t+j}[m] - {MC}_{t+j}\right) {\color{blue}Y^{d}_{t+j}[m]}
\Bigg \} + \cdots
\\
&\overset{\eqref{eq:NewKeynesian.Firms.TotalDemand}}{=} \mathbb{E}_{t} \sum_{j=0}^{\infty} \mathcal{M}_{t,t+j} \Bigg \{
\left(P_{t+j}[m] - {MC}_{t+j}\right) {\color{blue} {\left(\frac{P_{t+j}[m]}{P_{t+j}}\right)}^{-\epsilon^{P}} y_{t+j}}
\Bigg \} + \cdots
\\
&= \mathbb{E}_{t} \sum_{j=0}^{\infty} \mathcal{M}_{t,t+j} {(P_{t+j})}^{\epsilon^{P}} y_{t+j}
\Bigg \{
{(P_{t+j}[m])}^{1-\epsilon^{P}} - {MC}_{t+j}{(P_{t+j}[m])}^{-\epsilon^{P}}
\Bigg \} + \cdots
\end{align*}
When firms decide how to set their price they need to take into account
  that due to the Calvo mechanism they might get stuck at \(\widetilde{P}_{t}[m]\) for a number of periods \(j=1,2,\cdots \)
  before they can re-optimize again.
The probability of such a situation is \({(\theta^P)}^{j}\).
Therefore, when firms are able to change prices in period \(t\),
  they take this into account and we can focus on the \({(\theta^P)}^{j}\) scenario:
\begin{align*}
\mathcal{L} &= 
\mathbb{E}_{t} \sum_{j=0}^{\infty} {\color{red} {(\theta^P)}^{j}} \mathcal{M}_{t,t+j} {(P_{t+j})}^{\epsilon^{P}} y_{t+j}
\Bigg \{
{({\color{red} \widetilde{P}_{t}[m]})}^{1-\epsilon^{P}} - {MC}_{t+j}{({\color{red} \widetilde{P}_{t}[m]})}^{-\epsilon^{P}}
\Bigg \} + \cdots
\end{align*}

\item
Setting the first-order condition of \(\mathcal{L}\) with respect to \(\widetilde{P}_{t}[m]\) to zero yields:
\begin{multline*}
(\epsilon^{P}-1) \cdot {(\widetilde{P}_{t}[m])}^{-\epsilon^{P}}
\mathbb{E}_{t} \sum_{j=0}^{\infty} {(\theta^{P})}^{j} \mathcal{M}_{t,t+j} P_{t+j}^{\epsilon^{P}} y_{t+j}
\\
=
\epsilon^{P} \cdot {(\widetilde{P}_{t}[m])}^{-\epsilon^{P}-1}
\mathbb{E}_{t} \sum_{j=0}^{\infty} {(\theta^{P})}^{j} \mathcal{M}_{t,t+j} P_{t+j}^{\epsilon^{P}} y_{t+j} {MC}_{t+j}
\end{multline*}
As \(\widetilde{P}_{t}[m]>0\) does not depend on \(j\), we multiply by \({(\widetilde{P}_t[m])}^{\epsilon^{P}+1}\) and re-arrange:
\begin{align*}
\widetilde{p}_{t}= \frac{\widetilde{P}_{t}[m]}{{\color{green}P_{t}}}
&= \left(\frac{\epsilon^{P}}{\epsilon^{P}-1}\right)
\frac{\overbrace{%  
  \mathbb{E}_{t} \sum_{j=0}^{\infty} {(\theta^{P})}^{j} \mathcal{M}_{t,t+j} {\left(\frac{P_{t+j}}{{\color{blue} P_{t}}}\right)}^{\epsilon^{P}} {\left(\frac{{\color{red}P_{t+j}}}{{\color{green} P_{t}}}\right)} \left(\frac{{MC}_{t+j}}{{\color{red}P_{t+j}}}\right) y_{t+j} 
}^{S^{1_{P}}_{t}}
}
{\underbrace{%
  \mathbb{E}_{t} \sum_{j=0}^{\infty} {(\theta^{P})}^{j} \mathcal{M}_{t,t+j} {\left(\frac{P_{t+j}}{{\color{blue} P_{t}}}\right)}^{\epsilon^{P}} y_{t+j}
}_{S^{2_{P}}_{t}}
}
\end{align*}
Note that the right-hand side is independent of \(m\),
  so \(\widetilde{P}_{t} = \widetilde{P}_{t}[m]\) for all \(m\)
  and one can drop the index \(m\) form the optimal reset price.

\emph{Interpretation:} As all firms face the same factor input prices, they choose the same capital to labor ratio and have the same marginal costs.
Therefore, all firms that are allowed to re-optimize will set the same relative reset price \(\widetilde{P}_{t}\).

\item 
\textbf{The numerator} can be expressed recursively:
{\small
\begin{align*}
&S^{1_{P}}_{t}
= \mathbb{E}_{t} \sum_{j=0}^{\infty} {(\theta^{P})}^{j} \mathcal{M}_{t,t+j} {\left(\frac{P_{t+j}}{P_{t}}\right)}^{\epsilon^{P}+1} y_{t+j} {mc}_{t+j}
\\
&= {(\theta^{P})}^{{\color{red}0}} \mathcal{M}_{t,t+{\color{red}0}} {\left(\frac{P_{t+{\color{red}0}}}{P_{t}}\right)}^{\epsilon^{P}+1} y_{t+{\color{red}0}} {mc}_{t+{\color{red}0}}
 + {\left(\frac{{\color{blue}P_{t+1}}}{P_{t}}\right)}^{\varepsilon^{P}+1}\mathbb{E}_{t} \sum_{j={\color{red}1}}^{\infty} {(\theta^{P})}^{j} \mathcal{M}_{t,t+j} {\left(\frac{P_{t+j}}{{\color{blue}P_{t+1}}}\right)}^{\epsilon^{P}+1} y_{t+j} {mc}_{t+j}
\\
&= {mc}_{t} y_{t}
 + {\left(\frac{P_{t+1}}{P_{t}}\right)}^{\varepsilon^{P}+1}\mathbb{E}_{t} \sum_{j={\color{red}0}}^{\infty} {(\theta^{P})}^{j{\color{red}+1}} {\color{green}\mathcal{M}_{t,t+j{\color{red}+1}}} {\left(\frac{P_{t+j{\color{red}+1}}}{P_{t+1}}\right)}^{\epsilon^{P}+1} y_{t+j{\color{red}+1}} {mc}_{t+j{\color{red}+1}}
\\
&\overset{{\color{green}\eqref{eq:NewKeynesian.StochasticDiscountFactorRecursive}}}{=} {mc}_{t} y_{t}
 + {\color{red}\theta^{P}} {\color{green} \beta \mathbb{E}_{t} \frac{\lambda_{t+1}}{\lambda_{t}} \frac{P_{t}}{P_{t+1}}}
 {\left(\frac{P_{t+1}}{P_{t}}\right)}^{\varepsilon^{P}+1}
 \underbrace{%
   \mathbb{E}_{t+1} \sum_{j=0}^{\infty} {(\theta^{P})}^{j} {\color{green}\mathcal{M}_{t+1,t+1+j}} {\left(\frac{P_{t+1+j}}{P_{t+1}}\right)}^{\epsilon^{P}+1} y_{t+1+j} {mc}_{t+1+j}
 }_{S^{1_{P}}_{t+1}}
\\
&\Leftrightarrow
S^{1_{P}}_{t}
= {mc}_{t} y_{t}
 + \theta^{P} \beta \mathbb{E}_{t} \frac{\lambda_{t+1}}{\lambda_{t}} {\left(\Pi_{t+1}\right)}^{\varepsilon^{P}} S^{1_{P}}_{t+1}
\end{align*}
}

\textbf{The denominator} can be expressed recursively:
\begin{align*}
&S^{2_{P}}_{t}
= \mathbb{E}_{t} \sum_{j=0}^{\infty} {(\theta^{P})}^{j} \mathcal{M}_{t,t+j} {\left(\frac{P_{t+j}}{P_{t}}\right)}^{\epsilon^{P}} y_{t+j}
\\
&= {(\theta^{P})}^{{\color{red}0}} \mathcal{M}_{t,t+{\color{red}0}} {\left(\frac{P_{t+{\color{red}0}}}{P_{t}}\right)}^{\epsilon^{P}} y_{t+{\color{red}0}}
 + {\left(\frac{{\color{blue}P_{t+1}}}{P_{t}}\right)}^{\varepsilon^{P}}\mathbb{E}_{t} \sum_{j={\color{red}1}}^{\infty} {(\theta^{P})}^{j} \mathcal{M}_{t,t+j} {\left(\frac{P_{t+j}}{{\color{blue}P_{t+1}}}\right)}^{\epsilon^{P}} y_{t+j}
\\
&= y_{t}
 + {\left(\frac{P_{t+1}}{P_{t}}\right)}^{\varepsilon^{P}}\mathbb{E}_{t} \sum_{j={\color{red}0}}^{\infty} {(\theta^{P})}^{j{\color{red}+1}} {\color{green}\mathcal{M}_{t,t+j{\color{red}+1}}} {\left(\frac{P_{t+j{\color{red}+1}}}{P_{t+1}}\right)}^{\epsilon^{P}} y_{t+j{\color{red}+1}}
\\
&\overset{{\color{green}\eqref{eq:NewKeynesian.StochasticDiscountFactorRecursive}}}{=} y_{t}
 + {\color{red}\theta^{P}} {\color{green} \beta \mathbb{E}_{t} \frac{\lambda_{t+1}}{\lambda_{t}} \frac{P_{t}}{P_{t+1}}}
 {\left(\frac{P_{t+1}}{P_{t}}\right)}^{\varepsilon^{P}}
 \underbrace{%
   \mathbb{E}_{t+1} \sum_{j=0}^{\infty} {(\theta^{P})}^{j} {\color{green}\mathcal{M}_{t+1,t+1+j}} {\left(\frac{P_{t+1+j}}{P_{t+1}}\right)}^{\epsilon^{P}} y_{t+1+j}
 }_{S^{2_{P}}_{t+1}}
\\
&\Leftrightarrow
S^{2_{P}}_{t}
= y_{t}
 + \theta^{P} \beta \mathbb{E}_{t} \frac{\lambda_{t+1}}{\lambda_{t}} {\left(\Pi_{t+1}\right)}^{\varepsilon^{P}-1} S^{2_{P}}_{t+1}
\end{align*}

Note that the auxiliary variables for the infinite sums are sometimes scaled differently, they are not unique in their definition.
For instance, let's define \(s^{1_P}_{t} = \lambda_{t} S^{1_P}_{t}\) and \(s^{2_P}_{t} = \lambda_{t} s_{2,t}\),
  then we can re-write the recursion equivalently by multiplying through with \(\lambda_t\)
  and re-defining \(s^{1_P}_{t+1} = \lambda_{t+1} S^{1_P}_{t+1}\) and \(s^{2_P}_{t+1} = \lambda_{t+1} s_{2,t+1}\).
		
\item
The law of motion for \(\widetilde{p}_{t}=\frac{\widetilde{P}_{t}[m]}{P_{t}}\) is given
  by combining the aggregate price index~\eqref{eq:NewKeynesian.Firms.AggregatePriceIndex} with the Calvo mechanism:
\begin{align*}
1 &= \frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{1-\epsilon^{P}} dm
= \frac{1}{n} \int_{optimizers} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{1-\epsilon^{P}} dm
+ \frac{1}{n} \int_{non-optimizers} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{1-\epsilon} dm
\end{align*}
That is, \((1-\theta^{P})\) firms can reset their price to \(P_{t}[m] = \widetilde{P}_{t}[m]\),
  whereas the remaining \(\theta \) firms cannot and are stuck at \(P_{t}[m]=P_{t-1}\).
We therefore have:
\begin{align*}
1 &= (1-\theta^{P}) {\left(\frac{\widetilde{P}_t[m]}{P_t}\right)}^{1-\epsilon^{P}} \underbrace{\frac{1}{n} \int_{0}^{n} dm}_{1}
  + \theta^{P} \frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t-1}[m]}{P_{t}}{\color{red}{\frac{P_{t-1}}{P_{t-1}}}}\right)}^{1-\epsilon^{P}} dm
\\
1 &= (1-\theta^{P}) {(\widetilde{p}_{t})}^{1-\epsilon^{P}}
  + \theta^{P} {\left(\frac{P_{t-1}}{P_{t}}\right)}^{1-\epsilon^{P}} \frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t-1}[m]}{P_{t-1}}\right)}^{1-\epsilon^{P}} dm
\\
1 &= (1-\theta^{P}) {(\widetilde{p}_{t})}^{1-\epsilon^{P}}
  + \theta^{P} {(\Pi_{t})}^{1-\epsilon^{P}} \underbrace{\frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t-1}[m]}{P_{t-1}} \right)}^{1-\epsilon^{P}} dm}_{\overset{\eqref{eq:NewKeynesian.Firms.AggregatePriceIndex}}{=}1}
\\
1 &= (1-\theta^{P}) {(\widetilde{p}_{t})}^{1-\epsilon^{P}} + \theta^{P} {(\Pi_{t})}^{\epsilon-1}
\end{align*}

\item
Such a rule was initially proposed by \textcite{Taylor_1993_DiscretionPolicyRules}
  as a statistical descriptor (estimated with OLS) of the Federal Reserve interest setting behavior in response to output gap and inflation.
In \textcite{Taylor_1993_DiscretionPolicyRules}'s preferred specification is given by
  \(\psi^{R_\Pi}=1.5\) and \(\psi^{R_Y}=0.5\) for a yearly or \(\psi^{R_Y}=0.5/4=0.125\) for a quarterly calibration.
Typically, the rule is augmented with one lag of the nominal interest rate to address strong persistence in the evolution of the nominal interest rate.
Also, some models feature a forward-looking behavior of the central bank arguing that it responds to forecasts of inflation and output gap.

\item
Deflating the nominal fiscal budget~\eqref{eq:NewKeynesian.FiscalBudgetNominal} by \(P_{t}\) and dividing by \(n\) yields:
\begin{gather*}
  \underbrace{\frac{1}{n} \int_{0}^{n} \frac{\mathcal{T}_{t}[h]}{P_{t}} dh}_{\tau_{t}}
= \underbrace{\frac{1}{n} \frac{G_{t}}{P_{t}}}_{g_{t}}
\end{gather*}

\item
In the model we re-express all equations in terms of relative prices or inflation rates,
  because we want stationary variables.
That is, if we have a path for inflation of 2\%,
  prices will always be 2\% higher in the next period (even in steady-state and the absence of shocks).
In a model we need to focus on the relative price changes, which are stationary,
  or in other words, on describing the dynamics around the Balanced Growth Path (BGP).

\item
Nominal profits of the intermediate firm \(m\) is given by revenues minus costs:
\begin{align*}
\mathcal{DIV}^{M}_{t}[m] =	
P_{t}[m] {\color{blue}Y^{d}_{t}[m]}
 - W_{t} l^{d}_{t}[m]
 - R^{K}_{t} k^{d}_{t-1}[m]
\end{align*}
Inserting total demand for good \(m\)~\eqref{eq:NewKeynesian.Firms.TotalDemand}
  and dividing by \(P_{t}\) yields the real profits of the intermediate firm \(m\):
\begin{align*}
\frac{\mathcal{DIV}^{M}_{t}[m]}{P_{t}}
= \left(\frac{P_{t}[m]}{P_{t}}\right) {\color{blue}{\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} y_{t}}  - w_{t} L^{d}_{t}[m] - r^{K}_{t} K^{d}_{t-1}[m]
\end{align*}
Integrating over \(m\) yields the aggregate profits of the intermediate firms (in per-capita):
\begin{align*}
\underbrace{\frac{1}{n} \int_{0}^{n} \frac{\mathcal{DIV}^{M}_{t}[m]}{P_{t}} dm}_{div^{M}_{t}}
&= \underbrace{\frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{1-\epsilon^{P}}dm}_{\overset{\eqref{eq:NewKeynesian.Firms.AggregatePriceIndex}}{=}1} y_{t}
- w_{t} \underbrace{\frac{1}{n} \int_{0}^{n} L^{d}_{t}[m] dm}_{l^{d}_{t}}
- r^{K}_{t} \underbrace{\frac{1}{n} \int_{0}^{n} K^{d}_{t-1}[m] dm}_{k^{d}_{t-1}}
\\
div^{M}_{t} &:= y_{t} - w_{t} l^{d}_{t} - r^{K}_{t} k^{d}_{t-1}
\end{align*}
Alternatively, one can derive this using:
\begin{align*}
\mathcal{DIV}^{M}_{t}[m]
&= \left(P_{t}[m] - {MC}_{t}\right) {\color{blue}{\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} y_{t}}
\\
\frac{\mathcal{DIV}^{M}_{t}[m]}{P_{t}}
&= \left(\frac{P_{t}[m]}{P_{t}} - {mc}_{t}\right) {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} y_{t}
= {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{1-\epsilon^{P}} y_{t}
- {mc}_{t} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} y_{t}
\\
\underbrace{\frac{1}{n} \int_{0}^{n} \frac{\mathcal{DIV}^{M}_{t}[m]}{P_{t}}dm}_{div^{M}_{t}}
&= y_{t} \underbrace{\frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{1-\epsilon^{P}} dm}_{\overset{\eqref{eq:NewKeynesian.Firms.AggregatePriceIndex}}{=}1}
- {mc}_{t} y_{t} \frac{1}{n} \underbrace{\int_{0}^{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} dm}_{\overset{\eqref{eq:NewKeynesian.PriceDistortionDefinition}}{=}p_{t}^{*}}
\\
div^{M}_{t} = \left(1 - {mc}_{t} p_{t}^{*}\right) y_{t}
\end{align*}
Due to (i) the introduction of monopolistic competition and (ii) nominal price rigidities,
  intermediate firms charge a price larger than their marginal costs
  and will therefore earn profits such that \(div^{M}_{t}>0\).
However, these two frictions create an inefficient allocation compared to a model without these frictions (aka RBC model).

\item
Revisit the budget constraint in real terms:
\begin{multline*}
  \frac{R^{K}_{t}}{P_{t}} K_{t-1}[h]
+ \frac{W_{t}}{P_{t}} L^{s}_{t}[h]
+ \frac{1}{n} \int_{0}^{n} \frac{\mathcal{DIV}^{F}_{t}[f]}{P_{t}} df
+ \frac{1}{n} \int_{0}^{n} \frac{\mathcal{DIV}^{M}_{t}[m]}{P_{t}} dm
\\
=
\sum_{s' \in \mathcal{S}} P^{\mathcal{B}}_{t}[s'] \frac{\mathcal{B}_{t}[s',h]}{P_{t}}
- \frac{P_{t-1}}{P_{t}} \frac{\mathcal{B}_{t-1}[s,h]}{P_{t-1}}
+ C_{t}[h]
+ I_{t}[h]
+ \frac{\mathcal{T}_{t}[h]}{P_{t}}
\end{multline*}
Impose state-contingent bond market clearing~\eqref{eq:NewKeynesian.BondMarketClearing}
  and zero-profits~\eqref{eq:NewKeynesian.Firms.Final.ZeroProfit} in the final goods sector:
\begin{align*}
  r^{K}_{t} K_{t-1}[h]
+ w_{t} L^{s}_{t}[h]
+ {div}^{M}_{t}
=
C_{t}[h] + I_{t}[h]
+ \frac{\mathcal{T}_{t}[h]}{P_{t}}
\end{align*}
Integrating over \(h\):
\begin{multline*}
  r^{K}_{t} \underbrace{\frac{1}{n} \int_{0}^{n} K_{t-1}[h] dh}_{k_{t-1}}
+ w_{t} \underbrace{\frac{1}{n} \int_{0}^{n} L^{s}_{t}[h] dh}_{l_{t}}
+ {div}^{M}_{t} \underbrace{\frac{1}{n} \int_{0}^{n} dh}_{1}
\\
=
  \underbrace{\frac{1}{n} \int_{0}^{n} C_{t}[h] dh}_{c_{t}}
+ \underbrace{\frac{1}{n} \int_{0}^{n} I_{t}[h] dh}_{i_{t}}
+ \underbrace{\frac{1}{n} \int_{0}^{n} \frac{\mathcal{T}_{t}[h]}{P_{t}} dh}_{\tau_{t}}
\end{multline*}
Inserting the fiscal budget constraint~\eqref{eq:NewKeynesian.FiscalBudget} for \(\tau_{t}\) yields:
\begin{align*}
  r^{K}_{t} k_{t-1}
+ w_{t} l_{t}
+ {div}^{M}_{t}
=
  c_{t}
+ i_{t}
+ g_{t}
\end{align*}
Finally, using real dividends of the intermediate goods sector~\eqref{eq:NewKeynesian.IntermediateFirms.AggregateProfits},
  combined with clearing of the labor and capital markets~\eqref{eq:NewKeynesian.LaborMarketClearing} and~\eqref{eq:NewKeynesian.CapitalMarketClearing}, yields:
\begin{align*}
y_{t} = 
  r^{K}_{t} k_{t-1}
+ w_{t} l_{t}
+ y_t - w_t l^{d}_{t} - r^{K}_{t} k^{d}_{t-1}
= c_{t} + i_{t} + g_{t}
\end{align*}
\emph{Interpretation:} This is the aggregate demand equation.
	
\item
\textbf{First}, let's integrate the production function over \(m\):
\begin{align*}
\frac{1}{n} \int_{0}^{n} Y^{s}_{t}[m] dm = A_{t} \int_{0}^{n} {\left(\frac{K^{d}_{t-1}[m]}{L^{d}_{t}[m]}\right)}^{\alpha^{K}-1} K^{d}_{t-1}[m] dm
\end{align*}
From~\eqref{eq:NewKeynesian.IntermediateFirms.CapitalLaborRatio} we know that the labor to capital ratio is independent of \(m\)
  and equal to \(k^{d}_{t-1}/l^{d}_{t}\) and due to capital and labor market clearing also equal to \(k_{t-1}/l^{s}_{t}\):
\begin{align*}
\frac{1}{n} \int_{0}^{n} Y^{s}_{t}[m] dm = A_{t} {\left(\frac{k_{t-1}}{l^{s}_{t}}\right)}^{\alpha^{K}-1} \underbrace{\int_{0}^{n} K^{d}_{t-1}[m] dm}_{=k^{d}_{t-1}=k_{t-1}}
= A_{t} {(k_{t-1})}^{\alpha^{K}} {(l^{s}_{t})}^{1-\alpha^{K}}
\end{align*}

\textbf{Second}, let's integrate total demand for good \(m\) over \(m\):
\begin{align}
\frac{1}{n} \int_{0}^{n} Y^{d}_{t}[m] dm &:= y_{t}
\underbrace{\frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} dm}_{\overset{\eqref{eq:NewKeynesian.PriceDistortionDefinition}}{=}p_{t}^{*}}
= p_{t}^{*} y_{t}
\end{align}
where we simply made use of the definition of \(p_{t}^{*}\) in~\eqref{eq:NewKeynesian.PriceDistortionDefinition} to \emph{get rid of the integral}.

\textbf{Finally,} equating both expressions yields:
\begin{align*}
p_{t}^{*} y_{t} =  A_{t} {(k_{t-1})}^{\alpha^{K}} {(l^{s}_{t})}^{1-\alpha^{K}}
\end{align*}
\emph{Interpretation:} This is the aggregate supply equation.
Price frictions, however, imply that resources will not be efficiently allocated
  as prices are too high because not all firms can re-optimize their price in every period.
This inefficiency is measured by \(p_{t}^{*}\leq 1\); therefore it is called the \emph{price efficiency distortion}.

\item
The law of motion for the efficiency distortion \(p_{t}^{*}\) is given due to the Calvo price mechanism:
\begin{align*}
p_{t}^{*} &:= \frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} dm
\\
p_{t}^{*} & = \frac{1}{n} \int_{optimizers}     {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} dm
            + \frac{1}{n} \int_{non-optimizers} {\left(\frac{P_{t}[m]}{P_{t}}\right)}^{-\epsilon^{P}} dm
\\
p_{t}^{*} & = (1-\theta^{P}) {(\widetilde{p}_{t})}^{-\epsilon^{P}} + \theta^{P} \frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t-1}[m]}{P_t}\right)}^{-\epsilon^{P}} dm
\\
p_{t}^{*} & = (1-\theta^{P}) {(\widetilde{p}_{t})}^{-\epsilon^{P}} + \theta^{P} \frac{1}{n} \int_{0}^{n} {\left(\frac{P_{t-1}[m]}{P_t } {\color{red}\frac{P_{t-1}}{P_{t-1}}}\right)}^{-\epsilon^{P}} dm
\\
p_{t}^{*} & = (1-\theta^{P}) {(\widetilde{p}_{t})}^{-\epsilon^{P}} + \theta^{P} {\left(\frac{P_{t-1}}{P_{t}}\right)}^{-\epsilon^{P}} \int_{0}^{n} {\left(\frac{P_{t-1}[m]}{P_{t-1} }\right)}^{-\epsilon^{P}} dm
\\
p_{t}^{*} & = (1-\theta^{P}) {(\widetilde{p}_{t})}^{-\epsilon^{P}} + \theta^{P} {(\Pi_{t})}^{\epsilon^{P}} \underbrace{\int_{0}^{n} {\left(\frac{P_{t-1}[m]}{P_{t-1} }\right)}^{-\epsilon^{P}} dm}_{=p_{t-1}^{*}}
\\
p_{t}^{*} & = (1-\theta^{P}) {(\widetilde{p}_{t})}^{-\epsilon^{P}} + \theta^{P} {(\Pi_{t})}^{\epsilon^{P}} p_{t-1}^{*}
\end{align*}

\end{enumerate}